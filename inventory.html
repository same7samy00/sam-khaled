<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المنتجات - النظام المطور</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
             <div class="logo"><i class="fas fa-pills"></i><span>نظام الصيدلية</span></div>
             <nav class="main-nav">
                <ul>
                    <li><a href="index.html"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a></li>
                    <li class="active"><a href="inventory.html"><i class="fas fa-box-open"></i> إدارة المنتجات</a></li>
                    <li><a href="pos.html"><i class="fas fa-cash-register"></i> نقطة البيع</a></li>
                    <li><a href="sales_history.html"><i class="fas fa-history"></i> سجل المبيعات</a></li>
                    <li><a href="customers.html"><i class="fas fa-users"></i> إدارة العملاء</a></li>
                    <li><a href="settings.html"><i class="fas fa-cog"></i> الإعدادات</a></li>
                    <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <h2>إدارة المنتجات</h2>
                <button class="menu-toggle btn btn-secondary" id="menuToggle"><i class="fas fa-bars"></i></button>
                <button class="btn btn-primary" id="addProductBtn"><i class="fas fa-plus"></i> إضافة منتج جديد</button>
            </header>

            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>الاسم التجاري</th>
                            <th>المورد</th>
                            <th>كمية العلب</th>
                            <th>سعر بيع العلبة</th>
                            <th>سعر بيع الشريط</th>
                            <th>سعر بيع الحبة</th>
                            <th>تاريخ الإنتاج</th>
                            <th>تاريخ الصلاحية</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody"></tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modalTitle">إضافة منتج جديد</h3>
            <form id="productForm">
                <div class="form-row">
                    <div class="form-group"><label for="name">الاسم التجاري:</label><input type="text" id="name" required></div>
                    <div class="form-group"><label for="scientificName">الاسم العلمي:</label><input type="text" id="scientificName"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label for="supplier">المورد:</label><input type="text" id="supplier"></div>
                    <div class="form-group"><label for="productionDate">تاريخ الإنتاج:</label><input type="date" id="productionDate" required></div>
                    <div class="form-group"><label for="expiryDate">تاريخ الصلاحية:</label><input type="date" id="expiryDate" required></div>
                </div>
                 <hr style="margin: 15px 0; border-color: #eee;">
                <div class="form-row">
                    <div class="form-group">
                        <label for="barcode_box">باركود العلبة:</label>
                        <div class="input-with-btn">
                            <input type="text" id="barcode_box">
                            <button type="button" class="btn btn-secondary open-scanner-btn" data-target-input="barcode_box"><i class="fas fa-barcode"></i></button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="barcode_strip">باركود الشريط (اختياري):</label>
                        <div class="input-with-btn">
                            <input type="text" id="barcode_strip">
                            <button type="button" class="btn btn-secondary open-scanner-btn" data-target-input="barcode_strip"><i class="fas fa-barcode"></i></button>
                        </div>
                    </div>
                     <div class="form-group">
                        <label for="barcode_unit">باركود الحبة (اختياري):</label>
                        <div class="input-with-btn">
                            <input type="text" id="barcode_unit">
                            <button type="button" class="btn btn-secondary open-scanner-btn" data-target-input="barcode_unit"><i class="fas fa-barcode"></i></button>
                        </div>
                    </div>
                </div>
                 <hr style="margin: 15px 0; border-color: #eee;">
                <div class="form-row">
                    <div class="form-group"><label for="salePrice_box">سعر بيع العلبة:</label><input type="number" id="salePrice_box" step="0.01" required></div>
                    <div class="form-group"><label for="salePrice_strip">سعر بيع الشريط:</label><input type="number" id="salePrice_strip" step="0.01"></div>
                    <div class="form-group"><label for="salePrice_unit">سعر بيع الحبة:</label><input type="number" id="salePrice_unit" step="0.01"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label for="unitsPerBox">عدد الشرائط بالعلبة:</label><input type="number" id="unitsPerBox" required></div>
                    <div class="form-group"><label for="unitsPerStrip">عدد الحبات بالشريط:</label><input type="number" id="unitsPerStrip" required></div>
                </div>
                 <hr style="margin: 15px 0; border-color: #eee;">
                <div class="form-row">
                     <div class="form-group"><label for="stock_boxes">الكمية (عدد العلب):</label><input type="number" id="stock_boxes" required></div>
                     <div class="form-group"><label for="reorderLevel">حد إعادة الطلب (بالعلبة):</label><input type="number" id="reorderLevel" value="5"></div>
                </div>
                <div class="form-group">
                    <label for="notes">ملاحظات (مثال: يحتاج وصفة):</label>
                    <input type="text" id="notes">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 15px;">حفظ المنتج</button>
            </form>
        </div>
    </div>
    
    <div id="globalScannerModal" class="modal">
        <div class="modal-content small">
            <span class="close-button">&times;</span>
            <h3>مسح الباركود</h3>
            <div class="scanner-area">
                <video id="global-qr-video" style="width:100%;"></video>
            </div>
             <button class="btn btn-secondary" id="closeScannerModalBtn" style="width: 100%; margin-top: 15px;">إغلاق الماسح</button>
        </div>
    </div>

    <nav class="mobile-nav-bar">
        <a href="index.html"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a>
        <a href="inventory.html" class="active"><i class="fas fa-box-open"></i> المنتجات</a>
        <a href="pos.html"><i class="fas fa-cash-register"></i> البيع</a>
        <a href="sales_history.html"><i class="fas fa-history"></i> المبيعات</a>
        <a href="customers.html"><i class="fas fa-users"></i> العملاء</a>
    </nav>


    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Shared Setup ---
            const firebaseConfig = { apiKey: "AIzaSyAtePw7SP1R2POlPP9_Ot-YLNn0GQlebDg", authDomain: "pharmacy-6cc74.firebaseapp.com", projectId: "pharmacy-6cc74" };
            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            // Function to show Toastify notifications
            function showToast(message, type = 'info') {
                Toastify({
                    text: message,
                    duration: 3000,
                    newWindow: true,
                    close: true,
                    gravity: "top", // `top` or `bottom`
                    position: "center", // `left`, `center` or `right`
                    stopOnFocus: true, // Prevents dismissing on hover
                    className: `on-${type}`, // Custom class for styling
                    onClick: function(){} // Callback after click
                }).showToast();
            }

            // Mobile menu toggle logic
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.querySelector('.sidebar');
            const mobileNavBar = document.querySelector('.mobile-nav-bar');

            // Add class to body if mobile nav is present to adjust padding
            if (mobileNavBar) {
                document.body.classList.add('has-mobile-nav');
            }

            if (menuToggle) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('open');
                });
            }
            document.addEventListener('click', (event) => {
                if (window.innerWidth <= 768 && sidebar.classList.contains('open') && 
                    !sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
                    sidebar.classList.remove('open');
                }
            });

            auth.onAuthStateChanged(user => { if (!user) window.location.href = 'login.html'; });
            document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());

            // --- Scanner Logic ---
            const scannerModal = document.getElementById('globalScannerModal');
            const videoEl = document.getElementById('global-qr-video');
            const closeScannerModalBtn = document.getElementById('closeScannerModalBtn');
            let scanner = null;
            let targetInput = null;

            function openScanner(targetInputId) {
                targetInput = document.getElementById(targetInputId);
                scannerModal.style.display = 'flex';
                // Request camera permission when modal is opened
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then((stream) => {
                        videoEl.srcObject = stream;
                        scanner = new QrScanner(videoEl, result => {
                            if (targetInput) {
                                targetInput.value = result.data;
                            }
                            showToast('تم مسح الباركود بنجاح!', 'success');
                            closeScanner();
                        }, { highlightScanRegion: true, highlightCodeOutline: true });
                        scanner.start();
                    })
                    .catch(err => {
                        showToast("فشل تشغيل الكاميرا. يرجى منح الأذونات اللازمة للموقع.", 'error');
                        console.error(err);
                        closeScanner();
                    });
            };
            
            function closeScanner() {
                if (scanner) {
                    scanner.stop();
                    scanner.destroy();
                    scanner = null;
                }
                // Stop camera stream
                if (videoEl.srcObject) {
                    videoEl.srcObject.getTracks().forEach(track => track.stop());
                    videoEl.srcObject = null;
                }
                if(scannerModal) scannerModal.style.display = 'none';
            };

            document.querySelectorAll('.open-scanner-btn').forEach(btn => {
                btn.addEventListener('click', (e) => openScanner(e.currentTarget.dataset.targetInput));
            });
            if(scannerModal) scannerModal.querySelector('.close-button').addEventListener('click', closeScanner);
            if(closeScannerModalBtn) closeScannerModalBtn.addEventListener('click', closeScanner); // New button to close scanner

            // --- Page specific logic ---
            const productModal = document.getElementById('productModal');
            const addProductBtn = document.getElementById('addProductBtn');
            const productForm = document.getElementById('productForm');
            const productTableBody = document.getElementById('productTableBody');
            const modalTitle = document.getElementById('modalTitle');
            let editingProductId = null;

            // Auto-calculate strip/unit prices if not provided
            const salePriceBoxInput = document.getElementById('salePrice_box');
            const salePriceStripInput = document.getElementById('salePrice_strip');
            const salePriceUnitInput = document.getElementById('salePrice_unit');
            const unitsPerBoxInput = document.getElementById('unitsPerBox');
            const unitsPerStripInput = document.getElementById('unitsPerStrip');

            function calculateDerivedPrices() {
                const salePriceBox = parseFloat(salePriceBoxInput.value);
                const unitsPerBox = parseInt(unitsPerBoxInput.value);
                const unitsPerStrip = parseInt(unitsPerStripInput.value);

                if (isNaN(salePriceBox) || salePriceBox <= 0) return;

                // Calculate strip price if not provided or 0
                if (unitsPerBox > 0 && (isNaN(parseFloat(salePriceStripInput.value)) || parseFloat(salePriceStripInput.value) === 0)) {
                    salePriceStripInput.value = (salePriceBox / unitsPerBox).toFixed(2);
                }

                // Calculate unit price if not provided or 0
                if (unitsPerBox > 0 && unitsPerStrip > 0 && (isNaN(parseFloat(salePriceUnitInput.value)) || parseFloat(salePriceUnitInput.value) === 0)) {
                    salePriceUnitInput.value = (salePriceBox / unitsPerBox / unitsPerStrip).toFixed(2);
                }
            }

            salePriceBoxInput.addEventListener('input', calculateDerivedPrices);
            unitsPerBoxInput.addEventListener('input', calculateDerivedPrices);
            unitsPerStripInput.addEventListener('input', calculateDerivedPrices);


            const openModal = (id = null, data = {}) => {
                editingProductId = id;
                modalTitle.textContent = id ? 'تعديل المنتج' : 'إضافة منتج جديد';
                productForm.reset();
                // Clear auto-calculated fields explicitly if they are not set manually
                salePriceStripInput.value = '';
                salePriceUnitInput.value = '';

                if (id) {
                    Object.keys(data).forEach(key => {
                        if(productForm[key]) {
                            // Special handling for number inputs to avoid "0" if undefined
                            if (typeof data[key] === 'number' && data[key] === 0 && (key === 'salePrice_strip' || key === 'salePrice_unit')) {
                                productForm[key].value = ''; // Set to empty string if 0, allowing auto-calculation
                            } else {
                                productForm[key].value = data[key];
                            }
                        }
                    });
                    // Recalculate if loading existing product (in case one of the derived prices was missing or 0)
                    calculateDerivedPrices();
                }
                productModal.style.display = 'flex';
            };
            const closeModal = () => productModal.style.display = 'none';

            addProductBtn.addEventListener('click', () => openModal());
            productModal.querySelector('.close-button').addEventListener('click', closeModal);

            productForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const productionDate = new Date(productForm.productionDate.value);
                const expiryDate = new Date(productForm.expiryDate.value);
                const today = new Date();
                today.setHours(0,0,0,0); // Reset time for comparison

                if (productionDate > expiryDate) {
                    showToast('تاريخ الإنتاج لا يمكن أن يكون بعد تاريخ الصلاحية.', 'error');
                    return;
                }
                if (expiryDate < today) {
                    showToast('لا يمكن إضافة منتج منتهي الصلاحية.', 'error');
                    return;
                }

                calculateDerivedPrices(); // Ensure derived prices are calculated before saving

                const stockBoxes = parseInt(productForm.stock_boxes.value);
                const unitsPerBox = parseInt(productForm.unitsPerBox.value);
                const unitsPerStrip = parseInt(productForm.unitsPerStrip.value);

                const productData = {
                    name: productForm.name.value,
                    scientificName: productForm.scientificName.value,
                    supplier: productForm.supplier.value,
                    barcode_box: productForm.barcode_box.value,
                    barcode_strip: productForm.barcode_strip.value,
                    barcode_unit: productForm.barcode_unit.value,
                    salePrice_box: parseFloat(productForm.salePrice_box.value),
                    // Use parseFloat or 0 if empty/invalid for derived prices
                    salePrice_strip: parseFloat(productForm.salePrice_strip.value) || 0, 
                    salePrice_unit: parseFloat(productForm.salePrice_unit.value) || 0,
                    unitsPerBox: unitsPerBox,
                    unitsPerStrip: unitsPerStrip,
                    stock_boxes: stockBoxes,
                    stock_strips: stockBoxes * unitsPerBox, // Calculated total strips
                    stock_units: stockBoxes * unitsPerBox * unitsPerStrip, // Calculated total units/pills
                    reorderLevel: parseInt(productForm.reorderLevel.value),
                    productionDate: productForm.productionDate.value,
                    expiryDate: productForm.expiryDate.value,
                    notes: productForm.notes.value
                };
                try {
                    if (editingProductId) {
                        await db.collection('products').doc(editingProductId).update(productData);
                        showToast('تم تحديث المنتج بنجاح!', 'success');
                    } else {
                        await db.collection('products').add(productData);
                        showToast('تم إضافة المنتج بنجاح!', 'success');
                    }
                    closeModal();
                } catch (error) { 
                    console.error("Error saving product:", error); 
                    showToast("خطأ في حفظ المنتج: " + error.message, 'error');
                }
            });

            db.collection('products').orderBy('name').onSnapshot(snapshot => {
                productTableBody.innerHTML = '';
                if(snapshot.empty) {
                    productTableBody.innerHTML = '<tr><td colspan="9" class="no-data-row">لا توجد منتجات. ابدأ بإضافة منتج جديد.</td></tr>';
                    return;
                }
                const today = new Date();
                today.setHours(0,0,0,0); // Reset time for accurate date comparison

                snapshot.forEach(doc => {
                    const p = doc.data();
                    const row = productTableBody.insertRow();
                    
                    const isLowStock = (p.stock_boxes !== undefined && p.reorderLevel !== undefined) && p.stock_boxes <= p.reorderLevel;
                    const expiry = p.expiryDate ? new Date(p.expiryDate) : null;
                    
                    let isExpiringSoon = false;
                    let isExpired = false;

                    if (expiry) {
                        expiry.setHours(0,0,0,0);
                        const daysUntilExpiry = (expiry - today) / (1000 * 60 * 60 * 24);
                        isExpired = daysUntilExpiry < 0;
                        isExpiringSoon = daysUntilExpiry < 90 && daysUntilExpiry >= 0;
                    }
                    
                    let rowClass = '';
                    if (isExpired) {
                        rowClass = 'expired-product';
                    } else if (isLowStock) {
                        rowClass = 'low-stock-product';
                    } else if (isExpiringSoon) {
                        rowClass = 'expiring-soon-product';
                    }
                    row.className = rowClass;

                    row.innerHTML = `
                        <td>${p.name}</td>
                        <td>${p.supplier || 'N/A'}</td>
                        <td>${p.stock_boxes !== undefined ? p.stock_boxes : 'N/A'}</td>
                        <td>${p.salePrice_box !== undefined ? p.salePrice_box.toFixed(2) : 'N/A'}</td>
                        <td>${p.salePrice_strip !== undefined ? p.salePrice_strip.toFixed(2) : 'N/A'}</td>
                        <td>${p.salePrice_unit !== undefined ? p.salePrice_unit.toFixed(2) : 'N/A'}</td>
                        <td>${p.productionDate || 'N/A'}</td>
                        <td>${p.expiryDate || 'N/A'}</td>
                        <td class="actions-cell">
                            <button class="btn btn-primary edit-btn" data-id="${doc.id}"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger delete-btn" data-id="${doc.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                });
            });

            productTableBody.addEventListener('click', async (e) => {
                const button = e.target.closest('button');
                if(!button) return;
                const id = button.dataset.id;
                
                if(button.classList.contains('edit-btn')) {
                    const docSnap = await db.collection('products').doc(id).get();
                    if(docSnap.exists) {
                       openModal(id, docSnap.data());
                    } else {
                        showToast('المنتج غير موجود.', 'error');
                    }
                } else if (button.classList.contains('delete-btn')) {
                    if(confirm('هل أنت متأكد من الحذف؟')) {
                        try {
                            await db.collection('products').doc(id).delete();
                            showToast('تم حذف المنتج بنجاح!', 'success');
                        } catch (error) {
                            console.error("Error deleting product:", error);
                            showToast("خطأ في حذف المنتج: " + error.message, 'error');
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>