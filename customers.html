<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة العملاء</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="logo"><i class="fas fa-pills"></i><span>نظام الصيدلية</span></div>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a></li>
                    <li><a href="inventory.html"><i class="fas fa-box-open"></i> إدارة المنتجات</a></li>
                    <li><a href="pos.html"><i class="fas fa-cash-register"></i> نقطة البيع</a></li>
                    <li><a href="sales_history.html"><i class="fas fa-history"></i> سجل المبيعات</a></li>
                    <li class="active"><a href="customers.html"><i class="fas fa-users"></i> إدارة العملاء</a></li>
                    <li><a href="settings.html"><i class="fas fa-cog"></i> الإعدادات</a></li>
                    <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <h2>إدارة العملاء</h2>
                <button class="menu-toggle btn btn-secondary" id="menuToggle"><i class="fas fa-bars"></i></button>
                <button class="btn btn-primary" id="addCustomerBtn"><i class="fas fa-user-plus"></i> إضافة عميل جديد</button>
            </header>

            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>الهاتف</th>
                            <th>الديون الحالية</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="customerTableBody"></tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="customerModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modalTitle">إضافة عميل جديد</h3>
            <form id="customerForm">
                <div class="form-row">
                    <div class="form-group"><label for="customerName">اسم العميل:</label><input type="text" id="customerName" required></div>
                    <div class="form-group"><label for="customerPhone">رقم الهاتف:</label><input type="text" id="customerPhone"></div>
                </div>
                <div class="form-group"><label for="customerAddress">العنوان:</label><input type="text" id="customerAddress"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 15px;">حفظ العميل</button>
            </form>
        </div>
    </div>
    
    <div id="payDebtModal" class="modal">
        <div class="modal-content small">
            <span class="close-button">&times;</span>
            <h3 id="payDebtModalTitle">سداد دين</h3>
            <form id="payDebtForm">
                <div class="form-group">
                    <label for="debtAmountToPay">المبلغ المدفوع:</label>
                    <input type="number" id="debtAmountToPay" step="0.01" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">تأكيد السداد</button>
            </form>
        </div>
    </div>

    <nav class="mobile-nav-bar">
        <a href="index.html"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a>
        <a href="inventory.html"><i class="fas fa-box-open"></i> المنتجات</a>
        <a href="pos.html"><i class="fas fa-cash-register"></i> البيع</a>
        <a href="sales_history.html"><i class="fas fa-history"></i> المبيعات</a>
        <a href="customers.html" class="active"><i class="fas fa-users"></i> العملاء</a>
    </nav>

    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = { apiKey: "AIzaSyAtePw7SP1R2POlPP9_Ot-YLNn0GQlebDg", authDomain: "pharmacy-6cc74.firebaseapp.com", projectId: "pharmacy-6cc74" };
            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            // Function to show Toastify notifications
            function showToast(message, type = 'info') {
                Toastify({
                    text: message,
                    duration: 3000,
                    newWindow: true,
                    close: true,
                    gravity: "top", // `top` or `bottom`
                    position: "center", // `left`, `center` or `right`
                    stopOnFocus: true, // Prevents dismissing on hover
                    className: `on-${type}`, // Custom class for styling
                    onClick: function(){} // Callback after click
                }).showToast();
            }

            // Mobile menu toggle logic
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.querySelector('.sidebar');
            const mobileNavBar = document.querySelector('.mobile-nav-bar');

            if (mobileNavBar) {
                document.body.classList.add('has-mobile-nav');
            }

            if (menuToggle) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('open');
                });
            }
            document.addEventListener('click', (event) => {
                if (window.innerWidth <= 768 && sidebar.classList.contains('open') && 
                    !sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
                    sidebar.classList.remove('open');
                }
            });


            auth.onAuthStateChanged(user => { if (!user) window.location.href = 'login.html'; });
            document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());

            // --- Customer Modal Logic ---
            const customerModal = document.getElementById('customerModal');
            const addCustomerBtn = document.getElementById('addCustomerBtn');
            const customerForm = document.getElementById('customerForm');
            let editingCustomerId = null;
            
            const openCustomerModal = (id = null, data = {}) => {
                editingCustomerId = id;
                customerModal.querySelector('#modalTitle').textContent = id ? 'تعديل بيانات العميل' : 'إضافة عميل جديد';
                customerForm.reset();
                if (id) {
                    customerForm.customerName.value = data.name || '';
                    customerForm.customerPhone.value = data.phone || '';
                    customerForm.customerAddress.value = data.address || '';
                }
                customerModal.style.display = 'flex';
            };
            const closeCustomerModal = () => customerModal.style.display = 'none';
            addCustomerBtn.addEventListener('click', () => openCustomerModal());
            customerModal.querySelector('.close-button').addEventListener('click', closeCustomerModal);

            customerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const customerData = { name: customerForm.customerName.value, phone: customerForm.customerPhone.value, address: customerForm.customerAddress.value };
                try {
                    if (editingCustomerId) {
                        await db.collection('customers').doc(editingCustomerId).update(customerData);
                        showToast('تم تحديث العميل بنجاح!', 'success');
                    } else {
                        await db.collection('customers').add({ ...customerData, currentDebt: 0 });
                        showToast('تم إضافة العميل بنجاح!', 'success');
                    }
                    closeCustomerModal();
                } catch (error) { 
                    console.error("Error saving customer:", error); 
                    showToast("خطأ في حفظ العميل: " + error.message, 'error');
                }
            });
            
            // --- Pay Debt Modal Logic ---
            const payDebtModal = document.getElementById('payDebtModal');
            const payDebtForm = document.getElementById('payDebtForm');
            let payingDebtForCustomerId = null;
            
            const openPayDebtModal = (id, name) => {
                payingDebtForCustomerId = id;
                payDebtModal.querySelector('#payDebtModalTitle').textContent = `سداد دين: ${name}`;
                payDebtForm.reset();
                payDebtModal.style.display = 'flex';
            };
            const closePayDebtModal = () => payDebtModal.style.display = 'none';
            payDebtModal.querySelector('.close-button').addEventListener('click', closePayDebtModal);

            payDebtForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const amount = parseFloat(payDebtForm.debtAmountToPay.value);
                if (isNaN(amount) || amount <= 0) {
                    showToast("الرجاء إدخال مبلغ صحيح وموجب.", 'error');
                    return;
                }

                try {
                    const customerRef = db.collection('customers').doc(payingDebtForCustomerId);
                    await db.runTransaction(async (transaction) => {
                         const customerDoc = await transaction.get(customerRef);
                         if(!customerDoc.exists) throw new Error("العميل غير موجود!");
                         const currentDebt = customerDoc.data().currentDebt || 0;
                         if (amount > currentDebt) {
                             throw new Error("المبلغ المدفوع أكبر من الدين المستحق.");
                         }
                         const newDebt = currentDebt - amount;
                         transaction.update(customerRef, { currentDebt: newDebt });
                    });
                    showToast("تم تسجيل السداد بنجاح.", 'success');
                    closePayDebtModal();
                } catch (error) { 
                    console.error("Error paying debt:", error); 
                    showToast(`فشل سداد الدين: ${error.message}`, 'error');
                }
            });

            // --- Table Rendering and Events ---
            const customerTableBody = document.getElementById('customerTableBody');
            db.collection('customers').orderBy('name').onSnapshot(snapshot => {
                customerTableBody.innerHTML = '';
                if(snapshot.empty) {
                    customerTableBody.innerHTML = '<tr><td colspan="4" class="no-data-row">لا يوجد عملاء.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const customer = doc.data();
                    const row = customerTableBody.insertRow();
                    const currentDebt = customer.currentDebt !== undefined ? customer.currentDebt : 0;
                    row.innerHTML = `
                        <td>${customer.name}</td>
                        <td>${customer.phone || 'N/A'}</td>
                        <td>${currentDebt.toFixed(2)}</td>
                        <td class="actions-cell">
                            <button class="btn btn-secondary pay-debt-btn" data-id="${doc.id}" data-name="${customer.name}" ${currentDebt <= 0 ? 'disabled' : ''}><i class="fas fa-money-bill-wave"></i> سداد</button>
                            <button class="btn btn-primary edit-btn" data-id="${doc.id}"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger delete-btn" data-id="${doc.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                });
            });

            customerTableBody.addEventListener('click', async (e) => {
                const button = e.target.closest('button');
                if(!button) return;
                const id = button.dataset.id;
                
                if(button.classList.contains('edit-btn')) {
                    const docSnap = await db.collection('customers').doc(id).get();
                    if(docSnap.exists) {
                       openCustomerModal(id, docSnap.data());
                    } else {
                        showToast('العميل غير موجود.', 'error');
                    }
                } else if (button.classList.contains('delete-btn')) {
                    if(confirm('هل أنت متأكد من الحذف؟ سيتم حذف العميل وكل ديونه.')) {
                        try {
                            await db.collection('customers').doc(id).delete();
                            showToast('تم حذف العميل بنجاح!', 'success');
                        } catch (error) {
                            console.error("Error deleting customer:", error);
                            showToast("خطأ في حذف العميل: " + error.message, 'error');
                        }
                    }
                } else if (button.classList.contains('pay-debt-btn')) {
                    if (button.disabled) {
                        showToast('لا يوجد دين لهذا العميل لسداده.', 'info');
                        return;
                    }
                    openPayDebtModal(id, button.dataset.name);
                }
            });
        });
    </script>
</body>
</html>
