<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نقطة البيع</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="logo"><i class="fas fa-pills"></i><span>نظام الصيدلية</span></div>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a></li>
                    <li><a href="inventory.html"><i class="fas fa-box-open"></i> إدارة المنتجات</a></li>
                    <li class="active"><a href="pos.html"><i class="fas fa-cash-register"></i> نقطة البيع</a></li>
                    <li><a href="sales_history.html"><i class="fas fa-history"></i> سجل المبيعات</a></li>
                    <li><a href="customers.html"><i class="fas fa-users"></i> إدارة العملاء</a></li>
                    <li><a href="settings.html"><i class="fas fa-cog"></i> الإعدادات</a></li>
                    <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content" style="display: flex; flex-direction: column;">
            <header class="main-header">
                <h2>نقطة البيع والفاتورة</h2>
                <button class="menu-toggle btn btn-secondary" id="menuToggle"><i class="fas fa-bars"></i></button>
                <div class="user-info"><span></span> <i class="fas fa-user-circle"></i></div>
            </header>

            <section class="pos-section">
                <div class="pos-left-panel">
                    <h3>بحث عن منتج</h3>
                    <div class="form-group">
                        <div class="input-with-btn">
                             <input type="text" id="posProductSearch" placeholder="ابحث بالاسم أو الباركود...">
                             <button type="button" class="btn btn-secondary open-scanner-btn" data-target-input="posProductSearch"><i class="fas fa-barcode"></i></button>
                        </div>
                    </div>
                    <div id="posSearchResults">
                        <p class="no-data-row">ابحث عن منتج لإضافته للفاتورة.</p>
                    </div>
                    <h3 style="margin-top: 30px;">عناصر الفاتورة</h3>
                    <div class="invoice-items-table table-responsive" style="flex-grow: 1;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>المنتج</th>
                                    <th>الوحدة</th>
                                    <th>الكمية</th>
                                    <th>السعر</th>
                                    <th>الإجمالي</th>
                                    <th>حذف</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceItemsBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="pos-right-panel">
                    <h3>ملخص الفاتورة</h3>
                    <div class="form-group">
                        <label for="customerSelect">العميل:</label>
                        <select id="customerSelect"><option value="">عميل نقدي (غير مسجل)</option></select>
                        <input type="text" id="tempCustomerName" placeholder="اسم العميل (إذا كان غير مسجل)" style="margin-top: 5px; display: none;">
                    </div>
                     <div class="form-group">
                        <label for="paymentType">نوع الدفع:</label>
                        <select id="paymentType">
                            <option value="cash">نقدي</option>
                            <option value="credit">آجل</option>
                        </select>
                    </div>
                    <hr>
                    <div class="invoice-summary">
                        <p style="display: flex; justify-content: space-between;">المجموع: <span id="subTotal">0.00</span></p>
                        <p style="display: flex; justify-content: space-between; font-size: 20px; font-weight: bold; border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px;">
                            المبلغ المستحق: <span id="grandTotal" style="color: var(--primary-color);">0.00</span>
                        </p>
                    </div>
                    <button class="btn btn-primary" id="completeSaleBtn" style="width: 100%; padding: 15px; font-size: 18px; margin-top: 20px;">
                        <i class="fas fa-check-circle"></i> إتمام البيع
                    </button>
                    <button class="btn btn-secondary" id="printInvoiceBtn" style="width: 100%; padding: 15px; font-size: 18px; margin-top: 10px; display: none;">
                        <i class="fas fa-print"></i> طباعة الفاتورة
                    </button>
                </div>
            </section>
        </main>
    </div>
    
    <div id="globalScannerModal" class="modal">
        <div class="modal-content small">
            <span class="close-button">&times;</span>
            <h3>مسح الباركود</h3>
            <div class="scanner-area"><video id="global-qr-video"></video></div>
            <button class="btn btn-secondary" id="closeScannerModalBtn" style="width: 100%; margin-top: 15px;">إغلاق الماسح</button>
        </div>
    </div>

    <nav class="mobile-nav-bar">
        <a href="index.html"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a>
        <a href="inventory.html"><i class="fas fa-box-open"></i> المنتجات</a>
        <a href="pos.html" class="active"><i class="fas fa-cash-register"></i> البيع</a>
        <a href="sales_history.html"><i class="fas fa-history"></i> المبيعات</a>
        <a href="customers.html"><i class="fas fa-users"></i> العملاء</a>
    </nav>

    <div id="invoicePrintTemplate" style="display: none;">
        <div style="padding: 20px; font-family: 'Cairo', sans-serif; font-size: 12px; direction: rtl; text-align: right; width: 80mm; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">صيدلية الأمل</h2>
                <p style="margin: 5px 0;">رقم التواصل: 01xxxxxxxxx</p>
                <p style="margin: 5px 0;">تاريخ الفاتورة: <span id="invoiceDate"></span></p>
                <p style="margin: 5px 0;">رقم الفاتورة: <span id="invoiceNumber"></span></p>
            </div>
            <div style="margin-bottom: 15px;">
                <p>العميل: <span id="invoiceCustomerName"></span></p>
                <p>نوع الدفع: <span id="invoicePaymentType"></span></p>
            </div>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                <thead>
                    <tr style="background-color: #f2f2f2;">
                        <th style="border: 1px solid #ddd; padding: 6px; text-align: right;">المنتج</th>
                        <th style="border: 1px solid #ddd; padding: 6px; text-align: right;">وحدة</th>
                        <th style="border: 1px solid #ddd; padding: 6px; text-align: right;">كمية</th>
                        <th style="border: 1px solid #ddd; padding: 6px; text-align: right;">سعر</th>
                        <th style="border: 1px solid #ddd; padding: 6px; text-align: right;">إجمالي</th>
                    </tr>
                </thead>
                <tbody id="invoicePrintItemsBody">
                    </tbody>
            </table>
            <div style="text-align: left; border-top: 1px dashed #ccc; padding-top: 8px;">
                <p style="display: flex; justify-content: space-between; font-weight: bold; font-size: 14px;">الإجمالي الكلي: <span id="invoiceGrandTotal">0.00</span></p>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <p>شكراً لزيارتكم!</p>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Shared Setup ---
        const firebaseConfig = { apiKey: "AIzaSyAtePw7SP1R2POlPP9_Ot-YLNn0GQlebDg", authDomain: "pharmacy-6cc74.firebaseapp.com", projectId: "pharmacy-6cc74" };
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Function to show Toastify notifications
        function showToast(message, type = 'info') {
            Toastify({
                text: message,
                duration: 3000,
                newWindow: true,
                close: true,
                gravity: "top", // `top` or `bottom`
                position: "center", // `left`, `center` or `right`
                stopOnFocus: true, // Prevents dismissing on hover
                className: `on-${type}`, // Custom class for styling
                onClick: function(){} // Callback after click
            }).showToast();
        }

        // Mobile menu toggle logic
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.querySelector('.sidebar');
        const mobileNavBar = document.querySelector('.mobile-nav-bar');

        if (mobileNavBar) {
            document.body.classList.add('has-mobile-nav');
        }

        if (menuToggle) {
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
            });
        }
        document.addEventListener('click', (event) => {
            if (window.innerWidth <= 768 && sidebar.classList.contains('open') && 
                !sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
                sidebar.classList.remove('open');
            }
        });


        auth.onAuthStateChanged(user => {
            if (user) { document.querySelector('.user-info span').textContent = `مرحباً، ${user.email.split('@')[0]}`; } 
            else { window.location.href = 'login.html'; }
        });
        document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());

        // --- Scanner Logic ---
        const scannerModal = document.getElementById('globalScannerModal');
        const videoEl = document.getElementById('global-qr-video');
        const closeScannerModalBtn = document.getElementById('closeScannerModalBtn');
        let scanner = null;
        let targetInput = null;

        function openScanner(targetInputId) {
            targetInput = document.getElementById(targetInputId);
            scannerModal.style.display = 'flex';
            // Request camera permission when modal is opened
            navigator.mediaDevices.getUserMedia({ video: true })
                .then((stream) => {
                    videoEl.srcObject = stream;
                    scanner = new QrScanner(videoEl, result => {
                        if (targetInput) {
                            targetInput.value = result.data;
                            targetInput.dispatchEvent(new Event('input', { bubbles: true })); // Trigger input event for search
                        }
                        showToast('تم مسح الباركود بنجاح!', 'success');
                        closeScanner();
                    }, { highlightScanRegion: true, highlightCodeOutline: true });
                    scanner.start();
                })
                .catch(err => {
                    showToast("فشل تشغيل الكاميرا. يرجى منح الأذونات اللازمة للموقع.", 'error');
                    console.error(err);
                    closeScanner();
                });
        };

        function closeScanner() {
            if (scanner) {
                scanner.stop();
                scanner.destroy();
                scanner = null;
            }
            // Stop camera stream
            if (videoEl.srcObject) {
                videoEl.srcObject.getTracks().forEach(track => track.stop());
                videoEl.srcObject = null;
            }
            if(scannerModal) scannerModal.style.display = 'none';
        };

        document.querySelectorAll('.open-scanner-btn').forEach(btn => btn.addEventListener('click', e => openScanner(e.currentTarget.dataset.targetInput)));
        scannerModal.querySelector('.close-button').addEventListener('click', closeScanner);
        if(closeScannerModalBtn) closeScannerModalBtn.addEventListener('click', closeScanner);


        // --- POS Logic ---
        const searchInput = document.getElementById('posProductSearch');
        const searchResults = document.getElementById('posSearchResults');
        const invoiceItemsBody = document.getElementById('invoiceItemsBody');
        const subTotalEl = document.getElementById('subTotal');
        const grandTotalEl = document.getElementById('grandTotal');
        const completeSaleBtn = document.getElementById('completeSaleBtn');
        const customerSelect = document.getElementById('customerSelect');
        const tempCustomerNameInput = document.getElementById('tempCustomerName');
        const paymentTypeSelect = document.getElementById('paymentType');
        const printInvoiceBtn = document.getElementById('printInvoiceBtn');

        let invoiceItems = [];
        let searchTimeout;
        let lastSaleData = null; // To store data for printing


        // Load customers into dropdown
        db.collection('customers').orderBy('name').onSnapshot(snapshot => {
            customerSelect.innerHTML = '<option value="">عميل نقدي (غير مسجل)</option>';
            snapshot.forEach(doc => {
                const customer = doc.data();
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = customer.name;
                option.dataset.debt = customer.currentDebt || 0;
                customerSelect.appendChild(option);
            });
        });

        // Toggle temporary customer name input based on customer selection
        customerSelect.addEventListener('change', () => {
            if (customerSelect.value === '') {
                tempCustomerNameInput.style.display = 'block';
                tempCustomerNameInput.focus();
            } else {
                tempCustomerNameInput.style.display = 'none';
                tempCustomerNameInput.value = ''; // Clear temp name if a registered customer is selected
            }
        });

        const renderInvoice = () => {
            invoiceItemsBody.innerHTML = '';
            invoiceItems.forEach((item, index) => {
                const row = invoiceItemsBody.insertRow();
                
                // Ensure item.price is a valid number before toFixed
                const itemPrice = typeof item.price === 'number' ? item.price : 0;
                const itemQuantity = typeof item.quantity === 'number' ? item.quantity : 0;
                const itemTotal = itemPrice * itemQuantity;

                let unitOptions = `<option value="box" ${item.unit === 'علبة' ? 'selected' : ''}>علبة</option>`;
                // Check if strip price is available and unitsPerBox is valid
                if (item.originalProduct.salePrice_strip > 0 && item.originalProduct.unitsPerBox > 0) {
                    unitOptions += `<option value="strip" ${item.unit === 'شريط' ? 'selected' : ''}>شريط</option>`;
                }
                // Check if unit price is available and unitsPerStrip is valid
                if (item.originalProduct.salePrice_unit > 0 && item.originalProduct.unitsPerStrip > 0) {
                     unitOptions += `<option value="unit" ${item.unit === 'حبة' ? 'selected' : ''}>حبة</option>`;
                }

                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>
                        <select class="unit-select" data-index="${index}">
                            ${unitOptions}
                        </select>
                    </td>
                    <td><input type="number" value="${itemQuantity}" min="1" data-index="${index}"></td>
                    <td>${itemPrice.toFixed(2)}</td>
                    <td>${itemTotal.toFixed(2)}</td>
                    <td><button class="btn btn-danger delete-item-btn" data-index="${index}"><i class="fas fa-trash"></i></button></td>
                `;
            });
            calculateTotals();
        };

        const calculateTotals = () => {
            const total = invoiceItems.reduce((sum, item) => {
                const itemPrice = typeof item.price === 'number' ? item.price : 0;
                const itemQuantity = typeof item.quantity === 'number' ? item.quantity : 0;
                return sum + (itemPrice * itemQuantity);
            }, 0);
            subTotalEl.textContent = total.toFixed(2);
            grandTotalEl.textContent = total.toFixed(2);
        };
        
        invoiceItemsBody.addEventListener('change', (e) => {
            const index = e.target.dataset.index;
            const item = invoiceItems[index];
            if (!item) return; // Guard against undefined item

            if (e.target.classList.contains('unit-select')) {
                const selectedUnit = e.target.value;
                item.unit = selectedUnit === 'box' ? 'علبة' : (selectedUnit === 'strip' ? 'شريط' : 'حبة');
                
                // Update price based on selected unit, ensure prices exist before assigning
                if (selectedUnit === 'box') {
                    item.price = item.originalProduct.salePrice_box || 0;
                } else if (selectedUnit === 'strip') {
                    item.price = item.originalProduct.salePrice_strip || 0;
                } else if (selectedUnit === 'unit') {
                    item.price = item.originalProduct.salePrice_unit || 0;
                }
                // Reset quantity to 1 when changing unit, as stock logic is based on initial add
                item.quantity = 1; 
            } else if (e.target.tagName === 'INPUT') {
                const newQuantity = parseInt(e.target.value);
                if (isNaN(newQuantity) || newQuantity < 1) {
                    e.target.value = item.quantity; // Revert to old quantity if invalid
                    showToast('الكمية يجب أن تكون رقماً صحيحاً وأكبر من 0.', 'error');
                    return;
                }
                item.quantity = newQuantity;
            }
            renderInvoice();
        });

        invoiceItemsBody.addEventListener('click', (e) => {
            const btn = e.target.closest('.delete-item-btn');
            if(btn) {
                invoiceItems.splice(btn.dataset.index, 1);
                renderInvoice();
            }
        });

        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            const term = searchInput.value.trim();
            if (term.length < 2) { searchResults.innerHTML = '<p class="no-data-row">ابحث عن منتج لإضافته للفاتورة.</p>'; return; };
            searchTimeout = setTimeout(async () => {
                searchResults.innerHTML = '';
                let productsFound = [];

                // Search by Barcode
                const byBoxBarcode = await db.collection('products').where('barcode_box', '==', term).get();
                byBoxBarcode.forEach(doc => productsFound.push({ doc, unit: 'علبة' }));

                const byStripBarcode = await db.collection('products').where('barcode_strip', '==', term).get();
                byStripBarcode.forEach(doc => {
                    const product = doc.data();
                    if (product.salePrice_strip > 0 && product.unitsPerBox > 0) { // Only add if strip price is set and unitsPerBox is defined
                        productsFound.push({ doc, unit: 'شريط' });
                    }
                });

                const byUnitBarcode = await db.collection('products').where('barcode_unit', '==', term).get();
                byUnitBarcode.forEach(doc => {
                    const product = doc.data();
                    if (product.salePrice_unit > 0 && product.unitsPerStrip > 0) { // Only add if unit price is set and unitsPerStrip is defined
                        productsFound.push({ doc, unit: 'حبة' });
                    }
                });

                // Search by Name (case-insensitive, partial match)
                if (productsFound.length === 0 || term.length > 5) { // Prioritize barcode, then name search if no barcode or longer term
                    const nameSearchSnapshot = await db.collection('products')
                                                     .orderBy('name')
                                                     .startAt(term)
                                                     .endAt(term + '\uf8ff')
                                                     .get();
                    nameSearchSnapshot.forEach(doc => {
                        const product = doc.data();
                        // Add all available units for name search results
                        productsFound.push({ doc, unit: 'علبة' });
                        if (product.unitsPerBox > 0 && product.salePrice_strip > 0) {
                            productsFound.push({ doc, unit: 'شريط' });
                        }
                        if (product.unitsPerStrip > 0 && product.salePrice_unit > 0) {
                            productsFound.push({ doc, unit: 'حبة' });
                        }
                    });
                }
                
                if (productsFound.length === 0) {
                    searchResults.innerHTML = '<p class="no-data-row">لا يوجد منتجات مطابقة.</p>';
                    return;
                }

                // Display unique products (can have multiple units for the same product)
                searchResults.innerHTML = ''; // Clear previous results
                const displayedProducts = new Set(); // To avoid duplicate product-unit combinations

                productsFound.forEach(({ doc, unit }) => {
                    const product = doc.data();
                    const productUnitKey = `${doc.id}-${unit}`;
                    if (displayedProducts.has(productUnitKey)) {
                        return; // Skip if already added
                    }
                    displayedProducts.add(productUnitKey);

                    let priceToDisplay;
                    if (unit === 'علبة') priceToDisplay = product.salePrice_box;
                    else if (unit === 'شريط') priceToDisplay = product.salePrice_strip;
                    else if (unit === 'حبة') priceToDisplay = product.salePrice_unit;
                    
                    if (priceToDisplay === undefined || priceToDisplay === null) {
                        priceToDisplay = 0; // Default to 0 if price is undefined/null
                    }

                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'add-item-btn';
                    resultDiv.dataset.id = doc.id;
                    resultDiv.dataset.unit = unit;
                    resultDiv.innerHTML = `<span>${product.name} - ${unit} ( ${priceToDisplay.toFixed(2)} جنيه )</span>`;
                    searchResults.appendChild(resultDiv);
                });

            }, 300);
        });

        searchResults.addEventListener('click', async (e) => {
            const itemDiv = e.target.closest('.add-item-btn');
            if(itemDiv){
                const docSnap = await db.collection('products').doc(itemDiv.dataset.id).get();
                if (!docSnap.exists) {
                    showToast('المنتج لم يعد موجوداً في المخزون.', 'error');
                    return;
                }
                const product = docSnap.data();
                const unit = itemDiv.dataset.unit;

                // Validate stock before adding to invoice
                const unitsPerBox = product.unitsPerBox || 1;
                const unitsPerStrip = product.unitsPerStrip || 1;
                let currentTotalUnits = product.stock_units || 0;
                
                let desiredUnitValue = 1; // Default to 1 for initial add

                // Determine the equivalent total units for the desired unit
                let unitFactor = 1; // How many 'units' (pills) are in the selected item unit
                let itemPrice = 0;

                if (unit === 'علبة') {
                    unitFactor = unitsPerBox * unitsPerStrip;
                    itemPrice = product.salePrice_box || 0;
                } else if (unit === 'شريط') {
                    unitFactor = unitsPerStrip;
                    itemPrice = product.salePrice_strip || 0;
                } else if (unit === 'حبة') {
                    unitFactor = 1;
                    itemPrice = product.salePrice_unit || 0;
                }

                if (currentTotalUnits < unitFactor) { // Check if even one piece of the selected unit is available
                    showToast(`عذرًا، لا يوجد كمية كافية من ${product.name} بوحدة ${unit}.`, 'error');
                    return;
                }

                const newItem = {
                    productId: docSnap.id,
                    name: product.name,
                    unit: unit,
                    quantity: 1, // Always add 1 initially
                    price: itemPrice,
                    originalProduct: product // Store original product data for stock calculations
                };
                
                const existingItemIndex = invoiceItems.findIndex(item => item.productId === newItem.productId && item.unit === newItem.unit);

                if (existingItemIndex > -1) {
                    const existingItem = invoiceItems[existingItemIndex];
                    let totalDesiredUnitsForExisting = (existingItem.quantity + 1) * unitFactor; // Check if adding one more exceeds total units
                    if (totalDesiredUnitsForExisting > currentTotalUnits) {
                        showToast(`لا يوجد كمية إضافية كافية من ${product.name} بوحدة ${unit}. المتوفر ${Math.floor(currentTotalUnits / unitFactor)} ${unit}.`, 'info');
                        return;
                    }
                    existingItem.quantity++;
                } 
                else { 
                    invoiceItems.push(newItem); 
                }
                renderInvoice();
            }
        });

        completeSaleBtn.addEventListener('click', async () => {
            if(invoiceItems.length === 0) {
                showToast('الفاتورة فارغة!', 'error');
                return;
            }
            
            let selectedCustomerId = customerSelect.value || null;
            let customerNameForSale = customerSelect.options[customerSelect.selectedIndex].textContent; // Use textContent for display

            if (paymentTypeSelect.value === 'credit') {
                if (!selectedCustomerId && !tempCustomerNameInput.value.trim()) {
                    showToast('يرجى اختيار عميل مسجل أو إدخال اسم العميل للبيع الآجل.', 'error');
                    return;
                }
                if (!selectedCustomerId && tempCustomerNameInput.value.trim()) {
                    customerNameForSale = tempCustomerNameInput.value.trim();
                }
            } else {
                customerNameForSale = 'عميل نقدي';
                selectedCustomerId = null; // Ensure no customer ID if cash sale and not chosen
            }


            const grandTotal = parseFloat(grandTotalEl.textContent);
            const saleData = {
                items: invoiceItems.map(i => ({ 
                    productId: i.productId, 
                    name: i.name, 
                    unit: i.unit, 
                    quantity: i.quantity, 
                    price: i.price 
                })),
                grandTotal: grandTotal,
                paymentType: paymentTypeSelect.value,
                customerId: selectedCustomerId,
                customerName: customerNameForSale,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                await db.runTransaction(async (transaction) => {
                    // 1. Check stock and prepare updates
                    for (const item of invoiceItems) {
                        const productRef = db.collection('products').doc(item.productId);
                        const productDoc = await transaction.get(productRef);
                        if (!productDoc.exists) throw new Error(`المنتج ${item.name} غير موجود في المخزون!`);

                        const productDataInDb = productDoc.data();
                        let currentTotalUnits = productDataInDb.stock_units || 0;
                        const unitsPerBox = productDataInDb.unitsPerBox || 1;
                        const unitsPerStrip = productDataInDb.unitsPerStrip || 1;

                        let unitsToDeduct;
                        if (item.unit === 'علبة') {
                            unitsToDeduct = item.quantity * unitsPerBox * unitsPerStrip;
                        } else if (item.unit === 'شريط') {
                            unitsToDeduct = item.quantity * unitsPerStrip;
                        } else if (item.unit === 'حبة') {
                            unitsToDeduct = item.quantity;
                        } else {
                            throw new Error(`وحدة غير صالحة للمنتج: ${item.name}`);
                        }

                        if (currentTotalUnits < unitsToDeduct) {
                            throw new Error(`الكمية غير كافية للمنتج: ${item.name} (${item.unit} - مطلوب ${item.quantity}). المتوفر ${Math.floor(currentTotalUnits / (item.unit === 'علبة' ? unitsPerBox * unitsPerStrip : (item.unit === 'شريط' ? unitsPerStrip : 1)))} ${item.unit} من هذا المنتج في المخزون.`);
                        }
                        
                        const newTotalUnits = currentTotalUnits - unitsToDeduct;
                        
                        // Recalculate boxes and strips from new total units
                        const newStockBoxes = Math.floor(newTotalUnits / (unitsPerBox * unitsPerStrip));
                        const remainderAfterBoxes = newTotalUnits % (unitsPerBox * unitsPerStrip);
                        const newStockStrips = Math.floor(remainderAfterBoxes / unitsPerStrip);

                        transaction.update(productRef, { 
                            stock_units: newTotalUnits,
                            stock_boxes: newStockBoxes,
                            stock_strips: newStockStrips
                        });
                    }

                    // 2. Update customer debt if sale is on credit
                    if (saleData.paymentType === 'credit') {
                        if (saleData.customerId && db.collection('customers').doc(saleData.customerId)) { // Existing customer and reference is valid
                            const customerRef = db.collection('customers').doc(saleData.customerId);
                            transaction.update(customerRef, { currentDebt: firebase.firestore.FieldValue.increment(grandTotal) });
                        } else if (saleData.customerName) { // New (temporary) customer for debt
                            const newCustomerRef = db.collection('customers').doc(); // Auto-generate new customer ID
                            saleData.customerId = newCustomerRef.id; // Store the new ID in saleData
                            transaction.set(newCustomerRef, { 
                                name: saleData.customerName, 
                                phone: '', 
                                address: '', 
                                currentDebt: grandTotal 
                            });
                        }
                    }

                    // 3. Create sale record
                    const saleRef = db.collection('sales').doc();
                    transaction.set(saleRef, saleData);

                    // Store last sale data for printing
                    lastSaleData = { ...saleData, id: saleRef.id };
                });

                showToast('تم البيع بنجاح!', 'success');
                printInvoiceBtn.style.display = 'block'; // Show print button
                invoiceItems = [];
                renderInvoice();
                searchInput.value = '';
                searchResults.innerHTML = '<p class="no-data-row">ابحث عن منتج لإضافته للفاتورة.</p>';
                tempCustomerNameInput.value = '';
                tempCustomerNameInput.style.display = 'none'; // Hide temp customer input
                customerSelect.value = ''; // Reset customer select
            } catch (error) {
                console.error("Sale failed: ", error);
                showToast(`فشل إتمام البيع: ${error.message}`, 'error');
            }
        });

        printInvoiceBtn.addEventListener('click', () => {
            if (!lastSaleData) {
                showToast('لا توجد فاتورة لطباعتها. يرجى إتمام عملية بيع أولاً.', 'info');
                return;
            }

            const printContent = document.getElementById('invoicePrintTemplate').cloneNode(true);
            printContent.style.display = 'block'; // Make it visible for printing

            printContent.querySelector('#invoiceDate').textContent = new Date().toLocaleString('ar-EG', { dateStyle: 'medium', timeStyle: 'short' });
            printContent.querySelector('#invoiceNumber').textContent = lastSaleData.id;
            printContent.querySelector('#invoiceCustomerName').textContent = lastSaleData.customerName;
            printContent.querySelector('#invoicePaymentType').textContent = lastSaleData.paymentType === 'cash' ? 'نقدي' : 'آجل';
            printContent.querySelector('#invoiceGrandTotal').textContent = lastSaleData.grandTotal.toFixed(2);

            const printItemsBody = printContent.querySelector('#invoicePrintItemsBody');
            printItemsBody.innerHTML = '';
            lastSaleData.items.forEach(item => {
                const row = printItemsBody.insertRow();
                const itemPrice = typeof item.price === 'number' ? item.price : 0;
                const itemQuantity = typeof item.quantity === 'number' ? item.quantity : 0;

                row.innerHTML = `
                    <td style="border: 1px solid #ddd; padding: 6px; text-align: right;">${item.name}</td>
                    <td style="border: 1px solid #ddd; padding: 6px; text-align: right;">${item.unit}</td>
                    <td style="border: 1px solid #ddd; padding: 6px; text-align: right;">${item.quantity}</td>
                    <td style="border: 1px solid #ddd; padding: 6px; text-align: right;">${itemPrice.toFixed(2)}</td>
                    <td style="border: 1px solid #ddd; padding: 6px; text-align: right;">${(itemPrice * itemQuantity).toFixed(2)}</td>
                `;
            });

            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>الفاتورة</title>');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                body { font-family: 'Cairo', sans-serif; margin: 0; padding: 0; direction: rtl; text-align: right; font-size: 12px; }
                .invoice-container { width: 80mm; margin: 0 auto; padding: 10px; }
                h2 { text-align: center; margin-bottom: 10px; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
                th, td { border: 1px solid #ddd; padding: 6px; text-align: right; }
                .summary-line { display: flex; justify-content: space-between; font-weight: bold; margin-top: 5px; }
            `);
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<div class="invoice-container">');
            printWindow.document.write(printContent.innerHTML);
            printWindow.document.write('</div></body></html>');
            printWindow.document.close();
            printWindow.print();
        });
    });
    </script>
</body>
</html>