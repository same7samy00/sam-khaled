<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نقطة البيع</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="logo"><i class="fas fa-pills"></i><span>نظام الصيدلية</span></div>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a></li>
                    <li><a href="inventory.html"><i class="fas fa-box-open"></i> إدارة المنتجات</a></li>
                    <li class="active"><a href="pos.html"><i class="fas fa-cash-register"></i> نقطة البيع</a></li>
                    <li><a href="sales_history.html"><i class="fas fa-history"></i> سجل المبيعات</a></li>
                    <li><a href="customers.html"><i class="fas fa-users"></i> إدارة العملاء</a></li>
                    <li><a href="settings.html"><i class="fas fa-cog"></i> الإعدادات</a></li>
                    <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content" style="display: flex; flex-direction: column;">
            <header class="main-header">
                <h2>نقطة البيع والفاتورة</h2>
                <button class="menu-toggle btn btn-secondary" id="menuToggle"><i class="fas fa-bars"></i></button>
                <div class="user-info"><span></span> <i class="fas fa-user-circle"></i></div>
            </header>

            <section class="pos-section">
                <div class="pos-left-panel">
                    <h3>بحث عن منتج</h3>
                    <div class="form-group">
                        <div class="input-with-btn">
                             <input type="text" id="posProductSearch" placeholder="ابحث بالاسم أو الباركود...">
                             <button type="button" class="btn btn-secondary open-scanner-btn" data-target-input="posProductSearch"><i class="fas fa-barcode"></i></button>
                        </div>
                    </div>
                    <div id="posSearchResults">
                        <p class="no-data-row">ابحث عن منتج لإضافته للفاتورة.</p>
                    </div>
                    <h3 style="margin-top: 30px;">عناصر الفاتورة</h3>
                    <div class="invoice-items-table table-responsive" style="flex-grow: 1;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>المنتج</th>
                                    <th>الوحدة</th>
                                    <th>الكمية</th>
                                    <th>السعر</th>
                                    <th>الإجمالي</th>
                                    <th>حذف</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceItemsBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="pos-right-panel">
                    <h3>ملخص الفاتورة</h3>
                    <div class="form-group">
                        <label for="customerSearchInput">بحث عن عميل:</label>
                        <input type="text" id="customerSearchInput" placeholder="ابحث باسم العميل أو رقمه...">
                        <div id="customerSearchResults" style="border: 1px solid #ddd; max-height: 150px; overflow-y: auto; display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label for="selectedCustomerName">العميل المحدد:</label>
                        <input type="text" id="selectedCustomerName" readonly value="عميل نقدي" style="background-color: #f0f0f0;">
                        <input type="hidden" id="selectedCustomerId" value="">
                        <button type="button" class="btn btn-secondary" id="clearCustomerBtn" style="margin-top: 5px; display: none;"><i class="fas fa-times"></i> مسح العميل</button>
                    </div>
                    <div class="form-group">
                        <label for="tempCustomerNameManual">اسم العميل (إذا كان غير مسجل وستتم إضافة دين):</label>
                        <input type="text" id="tempCustomerNameManual" placeholder="اسم العميل لـ 'آجل' بدون تسجيل مسبق">
                    </div>
                    
                     <div class="form-group">
                        <label for="paymentType">نوع الدفع:</label>
                        <select id="paymentType">
                            <option value="cash">نقدي</option>
                            <option value="credit">آجل</option>
                        </select>
                    </div>
                    <hr>
                    <div class="invoice-summary">
                        <p style="display: flex; justify-content: space-between;">المجموع الفرعي: <span id="subTotal">0.00</span></p>
                        <p style="display: flex; justify-content: space-between;">الخصم: <span id="discountAmount">0.00</span></p>
                        <p style="display: flex; justify-content: space-between; font-size: 20px; font-weight: bold; border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px;">
                            المبلغ المستحق: <span id="grandTotal" style="color: var(--primary-color);">0.00</span>
                        </p>
                    </div>
                    <button class="btn btn-primary" id="completeSaleBtn" style="width: 100%; padding: 15px; font-size: 18px; margin-top: 20px;">
                        <i class="fas fa-check-circle"></i> إتمام البيع
                    </button>
                    <button class="btn btn-secondary" id="printInvoiceBtn" style="width: 100%; padding: 15px; font-size: 18px; margin-top: 10px; display: none;">
                        <i class="fas fa-print"></i> طباعة الفاتورة
                    </button>
                </div>
            </section>
        </main>
    </div>
    
    <div id="globalScannerModal" class="modal">
        <div class="modal-content small">
            <span class="close-button">&times;</span>
            <h3>مسح الباركود</h3>
            <div class="scanner-area"><video id="global-qr-video"></video></div>
            <button class="btn btn-secondary" id="closeScannerModalBtn" style="width: 100%; margin-top: 15px;">إغلاق الماسح</button>
        </div>
    </div>

    <div id="invoiceDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>تفاصيل الفاتورة</h3>
            <div id="invoiceDetailsContent">
                </div>
            <button class="btn btn-secondary" id="printDetailedInvoiceBtn" style="margin-top: 20px; width: 100%;"><i class="fas fa-print"></i> طباعة الفاتورة</button>
        </div>
    </div>


    <nav class="mobile-nav-bar">
        <a href="index.html"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a>
        <a href="inventory.html"><i class="fas fa-box-open"></i> المنتجات</a>
        <a href="pos.html" class="active"><i class="fas fa-cash-register"></i> البيع</a>
        <a href="sales_history.html"><i class="fas fa-history"></i> المبيعات</a>
        <a href="customers.html"><i class="fas fa-users"></i> العملاء</a>
    </nav>

    <div id="invoicePrintTemplate" style="display: none;">
        <div style="padding: 10px; font-family: 'Cairo', sans-serif; font-size: 10px; direction: rtl; text-align: right; width: 78mm; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 10px;">
                <h3 style="margin: 0; font-size: 14px;">صيدلية الأمل</h3>
                <p style="margin: 2px 0;">رقم التواصل: <span id="printPharmacyContact"></span></p>
                <p style="margin: 2px 0;">التاريخ: <span id="printInvoiceDate"></span></p>
                <p style="margin: 2px 0;">رقم الفاتورة: <span id="printInvoiceNumber"></span></p>
            </div>
            <div style="margin-bottom: 10px;">
                <p>العميل: <span id="printCustomerName"></span></p>
                <p>نوع الدفع: <span id="printPaymentType"></span></p>
            </div>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: right;">المنتج</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: right;">وحدة</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: right;">كمية</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: right;">سعر</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: right;">إجمالي</th>
                    </tr>
                </thead>
                <tbody id="printInvoiceItemsBody">
                    </tbody>
            </table>
            <div style="text-align: left; border-top: 1px dashed #ccc; padding-top: 5px;">
                <p style="display: flex; justify-content: space-between; font-weight: bold; font-size: 12px;">المجموع: <span id="printSubTotal">0.00</span></p>
                <p style="display: flex; justify-content: space-between; font-weight: bold; font-size: 12px;">الخصم: <span id="printDiscountAmount">0.00</span></p>
                <p style="display: flex; justify-content: space-between; font-weight: bold; font-size: 14px;">الإجمالي الكلي: <span id="printGrandTotal">0.00</span></p>
            </div>
            <div style="text-align: center; margin-top: 15px; font-size: 9px;">
                <p>شكراً لزيارتكم!</p>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Shared Setup ---
        const firebaseConfig = { apiKey: "AIzaSyAtePw7SP1R2POlPP9_Ot-YLNn0GQlebDg", authDomain: "pharmacy-6cc74.firebaseapp.com", projectId: "pharmacy-6cc74" };
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Function to show Toastify notifications
        function showToast(message, type = 'info') {
            Toastify({
                text: message,
                duration: 3000,
                newWindow: true,
                close: true,
                gravity: "top", // `top` or `bottom`
                position: "center", // `left`, `center` or `right`
                stopOnFocus: true, // Prevents dismissing on hover
                className: `on-${type}`, // Custom class for styling
                onClick: function(){} // Callback after click
            }).showToast();
        }

        // Mobile menu toggle logic
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.querySelector('.sidebar');
        const mobileNavBar = document.querySelector('.mobile-nav-bar');

        if (mobileNavBar) {
            document.body.classList.add('has-mobile-nav');
        }

        if (menuToggle) {
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
            });
        }
        document.addEventListener('click', (event) => {
            if (window.innerWidth <= 768 && sidebar.classList.contains('open') && 
                !sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
                sidebar.classList.remove('open');
            }
        });

        auth.onAuthStateChanged(user => {
            if (user) { document.querySelector('.user-info span').textContent = `مرحباً، ${user.email.split('@')[0]}`; } 
            else { window.location.href = 'login.html'; }
        });
        document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());

        // --- Scanner Logic ---
        const scannerModal = document.getElementById('globalScannerModal');
        const videoEl = document.getElementById('global-qr-video');
        const closeScannerModalBtn = document.getElementById('closeScannerModalBtn');
        let scanner = null;
        let targetInput = null;

        function openScanner(targetInputId) {
            targetInput = document.getElementById(targetInputId);
            scannerModal.style.display = 'flex';
            // Prefer rear camera
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then((stream) => {
                    videoEl.srcObject = stream;
                    scanner = new QrScanner(videoEl, result => {
                        if (targetInput) {
                            targetInput.value = result.data;
                            targetInput.dispatchEvent(new Event('input', { bubbles: true })); // Trigger input event for search
                        }
                        showToast('تم مسح الباركود بنجاح!', 'success');
                        closeScanner();
                    }, { highlightScanRegion: true, highlightCodeOutline: true });
                    scanner.start();
                })
                .catch(err => {
                    showToast("فشل تشغيل الكاميرا. يرجى منح الأذونات اللازمة للموقع.", 'error');
                    console.error(err);
                    closeScanner();
                });
        };

        function closeScanner() {
            if (scanner) {
                scanner.stop();
                scanner.destroy();
                scanner = null;
            }
            // Stop camera stream
            if (videoEl.srcObject) {
                videoEl.srcObject.getTracks().forEach(track => track.stop());
                videoEl.srcObject = null;
            }
            if(scannerModal) scannerModal.style.display = 'none';
        };

        document.querySelectorAll('.open-scanner-btn').forEach(btn => btn.addEventListener('click', e => openScanner(e.currentTarget.dataset.targetInput)));
        scannerModal.querySelector('.close-button').addEventListener('click', closeScanner);
        if(closeScannerModalBtn) closeScannerModalBtn.addEventListener('click', closeScanner);


        // --- POS Logic ---
        const searchInput = document.getElementById('posProductSearch');
        const searchResults = document.getElementById('posSearchResults');
        const invoiceItemsBody = document.getElementById('invoiceItemsBody');
        const subTotalEl = document.getElementById('subTotal');
        const grandTotalEl = document.getElementById('grandTotal');
        const discountAmountEl = document.getElementById('discountAmount'); // New for discount
        const completeSaleBtn = document.getElementById('completeSaleBtn');
        const customerSearchInput = document.getElementById('customerSearchInput');
        const customerSearchResults = document.getElementById('customerSearchResults');
        const selectedCustomerNameEl = document.getElementById('selectedCustomerName');
        const selectedCustomerIdInput = document.getElementById('selectedCustomerId');
        const clearCustomerBtn = document.getElementById('clearCustomerBtn');
        const tempCustomerNameManualInput = document.getElementById('tempCustomerNameManual');
        const paymentTypeSelect = document.getElementById('paymentType');
        const printInvoiceBtn = document.getElementById('printInvoiceBtn');

        let invoiceItems = [];
        let searchTimeout;
        let customerSearchTimeout;
        let lastSaleData = null; // To store data for printing
        let pharmacySettings = {}; // To store pharmacy settings for invoice printing

        // Load pharmacy settings
        db.collection('settings').doc('pharmacyConfig').get().then(doc => {
            if (doc.exists) {
                pharmacySettings = doc.data();
            }
        }).catch(error => {
            console.error("Error loading pharmacy settings:", error);
            showToast("فشل تحميل إعدادات الصيدلية.", 'error');
        });

        // Customer Search Logic
        customerSearchInput.addEventListener('input', () => {
            clearTimeout(customerSearchTimeout);
            const term = customerSearchInput.value.trim();
            if (term.length < 2) {
                customerSearchResults.innerHTML = '';
                customerSearchResults.style.display = 'none';
                return;
            }
            customerSearchTimeout = setTimeout(async () => {
                customerSearchResults.innerHTML = '';
                customerSearchResults.style.display = 'block';
                const customersSnapshot = await db.collection('customers')
                    .orderBy('name')
                    .startAt(term)
                    .endAt(term + '\uf8ff')
                    .get();
                
                if (customersSnapshot.empty) {
                    customerSearchResults.innerHTML = '<div style="padding: 10px; color: var(--text-color-light);">لا يوجد عملاء مطابقون.</div>';
                    return;
                }

                customersSnapshot.forEach(doc => {
                    const customer = doc.data();
                    const customerDiv = document.createElement('div');
                    customerDiv.style.padding = '10px';
                    customerDiv.style.borderBottom = '1px solid #eee';
                    customerDiv.style.cursor = 'pointer';
                    customerDiv.textContent = `${customer.name} (${customer.phone || 'لا يوجد هاتف'}) - دين: ${(customer.currentDebt || 0).toFixed(2)}`;
                    customerDiv.dataset.id = doc.id;
                    customerDiv.dataset.name = customer.name;
                    customerSearchResults.appendChild(customerDiv);
                });
            }, 300);
        });

        customerSearchResults.addEventListener('click', (e) => {
            const customerDiv = e.target.closest('div');
            if (customerDiv && customerDiv.dataset.id) {
                selectedCustomerIdInput.value = customerDiv.dataset.id;
                selectedCustomerNameEl.value = customerDiv.dataset.name;
                tempCustomerNameManualInput.value = ''; // Clear manual input
                tempCustomerNameManualInput.style.display = 'none'; // Hide manual input
                clearCustomerBtn.style.display = 'block'; // Show clear button
                customerSearchResults.innerHTML = '';
                customerSearchResults.style.display = 'none';
                showToast(`تم تحديد العميل: ${customerDiv.dataset.name}`, 'info');
            }
        });

        clearCustomerBtn.addEventListener('click', () => {
            selectedCustomerIdInput.value = '';
            selectedCustomerNameEl.value = 'عميل نقدي';
            clearCustomerBtn.style.display = 'none';
            tempCustomerNameManualInput.style.display = 'none'; // Hide manual input again
            showToast('تم مسح العميل المحدد.', 'info');
        });

        // Show/hide manual customer name input based on payment type AND if no customer selected
        paymentTypeSelect.addEventListener('change', () => {
            if (paymentTypeSelect.value === 'credit' && selectedCustomerIdInput.value === '') {
                tempCustomerNameManualInput.style.display = 'block';
            } else {
                tempCustomerNameManualInput.style.display = 'none';
                tempCustomerNameManualInput.value = '';
            }
        });

        const renderInvoice = () => {
            invoiceItemsBody.innerHTML = '';
            invoiceItems.forEach((item, index) => {
                const row = invoiceItemsBody.insertRow();
                
                // Ensure item.price is a valid number before toFixed
                const itemPrice = typeof item.price === 'number' ? item.price : 0;
                const itemQuantity = typeof item.quantity === 'number' ? item.quantity : 0;
                const itemTotal = itemPrice * itemQuantity;

                let unitOptions = `<option value="box" ${item.unit === 'علبة' ? 'selected' : ''}>علبة</option>`;
                // Check if strip price is available and unitsPerBox is valid
                if (item.originalProduct.salePrice_strip > 0 && item.originalProduct.unitsPerBox > 0) {
                    unitOptions += `<option value="strip" ${item.unit === 'شريط' ? 'selected' : ''}>شريط</option>`;
                }
                // Check if unit price is available and unitsPerStrip is valid
                if (item.originalProduct.salePrice_unit > 0 && item.originalProduct.unitsPerStrip > 0) {
                     unitOptions += `<option value="unit" ${item.unit === 'حبة' ? 'selected' : ''}>حبة</option>`;
                }

                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>
                        <select class="unit-select" data-index="${index}">
                            ${unitOptions}
                        </select>
                    </td>
                    <td><input type="number" value="${itemQuantity}" min="1" data-index="${index}" style="width: 60px; text-align: center;"></td>
                    <td>${itemPrice.toFixed(2)}</td>
                    <td>${itemTotal.toFixed(2)}</td>
                    <td><button class="btn btn-danger delete-item-btn" data-index="${index}" style="padding: 5px 8px;"><i class="fas fa-trash"></i></button></td>
                `;
            });
            calculateTotals();
        };

        const calculateTotals = () => {
            const total = invoiceItems.reduce((sum, item) => {
                const itemPrice = typeof item.price === 'number' ? item.price : 0;
                const itemQuantity = typeof item.quantity === 'number' ? item.quantity : 0;
                return sum + (itemPrice * itemQuantity);
            }, 0);
            subTotalEl.textContent = total.toFixed(2);
            // No discount for now, can be added later from settings
            discountAmountEl.textContent = (0).toFixed(2); 
            grandTotalEl.textContent = total.toFixed(2);
        };
        
        invoiceItemsBody.addEventListener('change', (e) => {
            const index = e.target.dataset.index;
            const item = invoiceItems[index];
            if (!item) return;

            if (e.target.classList.contains('unit-select')) {
                const selectedUnit = e.target.value;
                item.unit = selectedUnit === 'box' ? 'علبة' : (selectedUnit === 'strip' ? 'شريط' : 'حبة');
                
                if (selectedUnit === 'box') {
                    item.price = item.originalProduct.salePrice_box || 0;
                } else if (selectedUnit === 'strip') {
                    item.price = item.originalProduct.salePrice_strip || 0;
                } else if (selectedUnit === 'unit') {
                    item.price = item.originalProduct.salePrice_unit || 0;
                }
                // Reset quantity to 1 when changing unit, as stock logic is based on initial add
                item.quantity = 1; 
            } else if (e.target.tagName === 'INPUT' && e.target.type === 'number') {
                const newQuantity = parseInt(e.target.value);
                if (isNaN(newQuantity) || newQuantity < 1) {
                    e.target.value = item.quantity;
                    showToast('الكمية يجب أن تكون رقماً صحيحاً وأكبر من 0.', 'error');
                    return;
                }
                item.quantity = newQuantity;
            }
            renderInvoice();
        });

        invoiceItemsBody.addEventListener('click', (e) => {
            const btn = e.target.closest('.delete-item-btn');
            if(btn) {
                invoiceItems.splice(btn.dataset.index, 1);
                renderInvoice();
            }
        });

        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            const term = searchInput.value.trim();
            if (term.length < 2) { searchResults.innerHTML = '<p class="no-data-row">ابحث عن منتج لإضافته للفاتورة.</p>'; return; };
            searchTimeout = setTimeout(async () => {
                searchResults.innerHTML = '';
                let productsFound = [];
                const searchPromises = [];

                // Search by Barcode
                searchPromises.push(db.collection('products').where('barcode_box', '==', term).get().then(snap => snap.forEach(doc => productsFound.push({ doc, unit: 'علبة' }))));
                searchPromises.push(db.collection('products').where('barcode_strip', '==', term).get().then(snap => snap.forEach(doc => {
                    const product = doc.data();
                    if (product.salePrice_strip > 0 && product.unitsPerBox > 0) productsFound.push({ doc, unit: 'شريط' });
                })));
                searchPromises.push(db.collection('products').where('barcode_unit', '==', term).get().then(snap => snap.forEach(doc => {
                    const product = doc.data();
                    if (product.salePrice_unit > 0 && product.unitsPerStrip > 0) productsFound.push({ doc, unit: 'حبة' });
                })));

                await Promise.all(searchPromises);

                // If no barcode matches or for a longer search term, also search by name
                if (productsFound.length === 0 || term.length > 3) { // Adjusted condition for name search
                    const nameSearchSnapshot = await db.collection('products')
                                                     .orderBy('name')
                                                     .startAt(term)
                                                     .endAt(term + '\uf8ff')
                                                     .get();
                    nameSearchSnapshot.forEach(doc => {
                        const product = doc.data();
                        // Only add if not already added by barcode and add all available units
                        const existingBox = productsFound.find(p => p.doc.id === doc.id && p.unit === 'علبة');
                        if (!existingBox) productsFound.push({ doc, unit: 'علبة' });

                        const existingStrip = productsFound.find(p => p.doc.id === doc.id && p.unit === 'شريط');
                        if (!existingStrip && product.unitsPerBox > 0 && product.salePrice_strip > 0) productsFound.push({ doc, unit: 'شريط' });

                        const existingUnit = productsFound.find(p => p.doc.id === doc.id && p.unit === 'حبة');
                        if (!existingUnit && product.unitsPerStrip > 0 && product.salePrice_unit > 0) productsFound.push({ doc, unit: 'حبة' });
                    });
                }
                
                if (productsFound.length === 0) {
                    searchResults.innerHTML = '<p class="no-data-row">لا يوجد منتجات مطابقة.</p>';
                    return;
                }

                // Display unique products (can have multiple units for the same product)
                searchResults.innerHTML = '';
                const displayedProducts = new Set(); // To avoid duplicate product-unit combinations

                productsFound.forEach(({ doc, unit }) => {
                    const product = doc.data();
                    const productUnitKey = `${doc.id}-${unit}`;
                    if (displayedProducts.has(productUnitKey)) {
                        return; // Skip if already added
                    }
                    displayedProducts.add(productUnitKey);

                    let priceToDisplay;
                    if (unit === 'علبة') priceToDisplay = product.salePrice_box;
                    else if (unit === 'شريط') priceToDisplay = product.salePrice_strip;
                    else if (unit === 'حبة') priceToDisplay = product.salePrice_unit;
                    
                    if (priceToDisplay === undefined || priceToDisplay === null) {
                        priceToDisplay = 0; // Default to 0 if price is undefined/null
                    }

                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'add-item-btn';
                    resultDiv.dataset.id = doc.id;
                    resultDiv.dataset.unit = unit;
                    resultDiv.innerHTML = `<span>${product.name} - ${unit} ( ${priceToDisplay.toFixed(2)} جنيه )</span>`;
                    searchResults.appendChild(resultDiv);
                });

            }, 300);
        });

        searchResults.addEventListener('click', async (e) => {
            const itemDiv = e.target.closest('.add-item-btn');
            if(itemDiv){
                const docSnap = await db.collection('products').doc(itemDiv.dataset.id).get();
                if (!docSnap.exists) {
                    showToast('المنتج لم يعد موجوداً في المخزون.', 'error');
                    return;
                }
                const product = docSnap.data();
                const unit = itemDiv.dataset.unit;

                // Validate stock before adding to invoice
                const unitsPerBox = product.unitsPerBox || 1;
                const unitsPerStrip = product.unitsPerStrip || 1;
                let currentTotalUnits = product.stock_units || 0;
                
                let unitFactor = 1; // How many 'units' (pills) are in the selected item unit
                let itemPrice = 0;

                if (unit === 'علبة') {
                    unitFactor = unitsPerBox * unitsPerStrip;
                    itemPrice = product.salePrice_box || 0;
                } else if (unit === 'شريط') {
                    unitFactor = unitsPerStrip;
                    itemPrice = product.salePrice_strip || 0;
                } else if (unit === 'حبة') {
                    unitFactor = 1;
                    itemPrice = product.salePrice_unit || 0;
                }

                if (currentTotalUnits < unitFactor) {
                    showToast(`عذرًا، لا يوجد كمية كافية من ${product.name} بوحدة ${unit}.`, 'error');
                    return;
                }

                // Check if product is expired
                if (product.expiryDate) {
                    const expiry = new Date(product.expiryDate);
                    expiry.setHours(0,0,0,0);
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    if (expiry < today) {
                        showToast(`تحذير: المنتج ${product.name} منتهي الصلاحية!`, 'warning');
                        // Optionally prevent adding expired products: return;
                    }
                }

                const newItem = {
                    productId: docSnap.id,
                    name: product.name,
                    unit: unit,
                    quantity: 1, // Always add 1 initially
                    price: itemPrice,
                    originalProduct: product // Store original product data for stock calculations
                };
                
                const existingItemIndex = invoiceItems.findIndex(item => item.productId === newItem.productId && item.unit === newItem.unit);

                if (existingItemIndex > -1) {
                    const existingItem = invoiceItems[existingItemIndex];
                    let totalDesiredUnitsForExisting = (existingItem.quantity + 1) * unitFactor;
                    if (totalDesiredUnitsForExisting > currentTotalUnits) {
                        showToast(`لا يوجد كمية إضافية كافية من ${product.name} بوحدة ${unit}. المتوفر ${Math.floor(currentTotalUnits / unitFactor)} ${unit}.`, 'info');
                        return;
                    }
                    existingItem.quantity++;
                } 
                else { 
                    invoiceItems.push(newItem); 
                }
                renderInvoice();
            }
        });

        completeSaleBtn.addEventListener('click', async () => {
            if(invoiceItems.length === 0) {
                showToast('الفاتورة فارغة!', 'error');
                return;
            }
            
            let selectedCustomerId = selectedCustomerIdInput.value || null;
            let customerNameForSale = selectedCustomerNameEl.value; // Get initial name from selected customer input

            if (paymentTypeSelect.value === 'credit') {
                if (!selectedCustomerId && !tempCustomerNameManualInput.value.trim()) {
                    showToast('يرجى اختيار عميل مسجل أو إدخال اسم العميل للبيع الآجل.', 'error');
                    return;
                }
                if (!selectedCustomerId && tempCustomerNameManualInput.value.trim()) {
                    customerNameForSale = tempCustomerNameManualInput.value.trim();
                }
            } else {
                customerNameForSale = 'عميل نقدي';
                selectedCustomerId = null; // Ensure no customer ID if cash sale and not chosen
            }


            const grandTotal = parseFloat(grandTotalEl.textContent);
            const saleData = {
                items: invoiceItems.map(i => ({ 
                    productId: i.productId, 
                    name: i.name, 
                    unit: i.unit, 
                    quantity: i.quantity, 
                    price: i.price 
                })),
                subTotal: parseFloat(subTotalEl.textContent),
                discount: parseFloat(discountAmountEl.textContent),
                grandTotal: grandTotal,
                paymentType: paymentTypeSelect.value,
                customerId: selectedCustomerId,
                customerName: customerNameForSale,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                await db.runTransaction(async (transaction) => {
                    // 1. Check stock and prepare updates
                    for (const item of invoiceItems) {
                        const productRef = db.collection('products').doc(item.productId);
                        const productDoc = await transaction.get(productRef);
                        if (!productDoc.exists) throw new Error(`المنتج ${item.name} غير موجود في المخزون!`);

                        const productDataInDb = productDoc.data();
                        let currentTotalUnits = productDataInDb.stock_units || 0;
                        const unitsPerBox = productDataInDb.unitsPerBox || 1;
                        const unitsPerStrip = productDataInDb.unitsPerStrip || 1;

                        let unitsToDeduct;
                        if (item.unit === 'علبة') {
                            unitsToDeduct = item.quantity * unitsPerBox * unitsPerStrip;
                        } else if (item.unit === 'شريط') {
                            unitsToDeduct = item.quantity * unitsPerStrip;
                        } else if (item.unit === 'حبة') {
                            unitsToDeduct = item.quantity;
                        } else {
                            throw new Error(`وحدة غير صالحة للمنتج: ${item.name}`);
                        }

                        if (currentTotalUnits < unitsToDeduct) {
                            throw new Error(`الكمية غير كافية للمنتج: ${item.name} (${item.unit} - مطلوب ${item.quantity}). المتوفر ${Math.floor(currentTotalUnits / (item.unit === 'علبة' ? (unitsPerBox * unitsPerStrip) : (item.unit === 'شريط' ? unitsPerStrip : 1)))} ${item.unit} من هذا المنتج في المخزون.`);
                        }
                        
                        // Check for expired product before deducting stock if not already handled by warning
                        if (productDataInDb.expiryDate) {
                            const expiry = new Date(productDataInDb.expiryDate);
                            expiry.setHours(0,0,0,0);
                            const today = new Date();
                            today.setHours(0,0,0,0);
                            if (expiry < today) {
                                showToast(`تم بيع منتج منتهي الصلاحية: ${productDataInDb.name}.`, 'warning');
                                // Optionally throw error here to prevent sale if strictly enforced
                            }
                        }

                        const newTotalUnits = currentTotalUnits - unitsToDeduct;
                        
                        const newStockBoxes = Math.floor(newTotalUnits / (unitsPerBox * unitsPerStrip));
                        const remainderAfterBoxes = newTotalUnits % (unitsPerBox * unitsPerStrip);
                        const newStockStrips = Math.floor(remainderAfterBoxes / unitsPerStrip);

                        transaction.update(productRef, { 
                            stock_units: newTotalUnits,
                            stock_boxes: newStockBoxes,
                            stock_strips: newStockStrips
                        });
                    }

                    // 2. Update customer debt if sale is on credit
                    if (saleData.paymentType === 'credit') {
                        if (saleData.customerId) { // Existing customer
                            const customerRef = db.collection('customers').doc(saleData.customerId);
                            transaction.update(customerRef, { currentDebt: firebase.firestore.FieldValue.increment(grandTotal) });
                        } else if (saleData.customerName) { // New (temporary) customer for debt
                            const newCustomerRef = db.collection('customers').doc(); // Auto-generate new customer ID
                            saleData.customerId = newCustomerRef.id; // Store the new ID in saleData
                            transaction.set(newCustomerRef, { 
                                name: saleData.customerName, 
                                phone: '', 
                                address: '', 
                                currentDebt: grandTotal 
                            });
                        }
                    }

                    // 3. Create sale record
                    const saleRef = db.collection('sales').doc();
                    transaction.set(saleRef, saleData);

                    // Store last sale data for printing
                    lastSaleData = { ...saleData, id: saleRef.id };
                });

                showToast('تم البيع بنجاح!', 'success');
                printInvoiceBtn.style.display = 'block'; // Show print button
                invoiceItems = [];
                renderInvoice();
                searchInput.value = '';
                searchResults.innerHTML = '<p class="no-data-row">ابحث عن منتج لإضافته للفاتورة.</p>';
                customerSearchInput.value = ''; // Clear customer search
                selectedCustomerIdInput.value = '';
                selectedCustomerNameEl.value = 'عميل نقدي';
                clearCustomerBtn.style.display = 'none';
                tempCustomerNameManualInput.value = '';
                tempCustomerNameManualInput.style.display = 'none'; // Hide manual input
                paymentTypeSelect.value = 'cash'; // Reset payment type
            } catch (error) {
                console.error("Sale failed: ", error);
                showToast(`فشل إتمام البيع: ${error.message}`, 'error');
            }
        });

        printInvoiceBtn.addEventListener('click', () => {
            if (!lastSaleData) {
                showToast('لا توجد فاتورة لطباعتها. يرجى إتمام عملية بيع أولاً.', 'info');
                return;
            }

            // Populate print template
            const printContent = document.getElementById('invoicePrintTemplate').cloneNode(true);
            
            printContent.querySelector('#printPharmacyContact').textContent = pharmacySettings.contactNumber || 'N/A';
            printContent.querySelector('#printInvoiceDate').textContent = new Date().toLocaleString('ar-EG', { dateStyle: 'medium', timeStyle: 'short' });
            printContent.querySelector('#printInvoiceNumber').textContent = lastSaleData.id;
            printContent.querySelector('#printCustomerName').textContent = lastSaleData.customerName;
            printContent.querySelector('#printPaymentType').textContent = lastSaleData.paymentType === 'cash' ? 'نقدي' : 'آجل';
            printContent.querySelector('#printSubTotal').textContent = lastSaleData.subTotal.toFixed(2);
            printContent.querySelector('#printDiscountAmount').textContent = (lastSaleData.discount || 0).toFixed(2);
            printContent.querySelector('#printGrandTotal').textContent = lastSaleData.grandTotal.toFixed(2);

            const printItemsBody = printContent.querySelector('#printInvoiceItemsBody');
            printItemsBody.innerHTML = '';
            lastSaleData.items.forEach(item => {
                const row = printItemsBody.insertRow();
                const itemPrice = typeof item.price === 'number' ? item.price : 0;
                const itemQuantity = typeof item.quantity === 'number' ? item.quantity : 0;

                row.innerHTML = `
                    <td style="border: 1px solid #ddd; padding: 4px; text-align: right;">${item.name}</td>
                    <td style="border: 1px solid #ddd; padding: 4px; text-align: right;">${item.unit}</td>
                    <td style="border: 1px solid #ddd; padding: 4px; text-align: right;">${item.quantity}</td>
                    <td style="border: 1px solid #ddd; padding: 4px; text-align: right;">${itemPrice.toFixed(2)}</td>
                    <td style="border: 1px solid #ddd; padding: 4px; text-align: right;">${(itemPrice * itemQuantity).toFixed(2)}</td>
                `;
            });

            // Open a new window for printing
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>الفاتورة</title>');
            // Embed styles directly for print consistency
            printWindow.document.write('<style>');
            printWindow.document.write(`
                body { font-family: 'Cairo', sans-serif; margin: 0; padding: 0; direction: rtl; text-align: right; font-size: 10px; }
                .invoice-container { width: 78mm; margin: 0 auto; padding: 5mm; }
                h3 { margin: 0; font-size: 14px; text-align: center; }
                p { margin: 2px 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 5px; }
                th, td { border: 1px solid #ddd; padding: 4px; text-align: right; }
                thead th { background-color: #f2f2f2; }
                .summary-line { display: flex; justify-content: space-between; font-weight: bold; margin-top: 5px; }
                .text-center { text-align: center; }
            `);
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<div class="invoice-container">');
            printWindow.document.write(printContent.innerHTML); // Inject the populated template
            printWindow.document.write('</div></body></html>');
            printWindow.document.close();
            printWindow.print();
        });
    });
    </script>
</body>
</html>
