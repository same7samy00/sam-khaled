<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نقطة البيع</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="logo"><i class="fas fa-pills"></i><span>نظام الصيدلية</span></div>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a></li>
                    <li><a href="inventory.html"><i class="fas fa-box-open"></i> إدارة المنتجات</a></li>
                    <li class="active"><a href="pos.html"><i class="fas fa-cash-register"></i> نقطة البيع</a></li>
                    <li><a href="sales_history.html"><i class="fas fa-history"></i> سجل المبيعات</a></li>
                    <li><a href="customers.html"><i class="fas fa-users"></i> إدارة العملاء</a></li>
                    <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content" style="display: flex; flex-direction: column;">
            <header class="main-header">
                <h2>نقطة البيع والفاتورة</h2>
                <div class="user-info"><span></span> <i class="fas fa-user-circle"></i></div>
            </header>

            <section class="pos-section" style="display: flex; gap: 20px; flex-grow: 1;">
                <div class="pos-left-panel" style="flex: 2; background: white; padding: 20px; border-radius: 8px; display: flex; flex-direction: column;">
                    <h3>بحث عن منتج</h3>
                    <div class="search-product-pos form-group">
                        <input type="text" id="posProductSearch" placeholder="ابحث باسم المنتج...">
                    </div>
                    <div id="posSearchResults" style="border: 1px solid #ddd; border-radius: 8px; padding: 10px; min-height: 150px; margin-top: 15px;">
                        <p class="no-data-row">ابحث عن منتج لإضافته للفاتورة.</p>
                    </div>
                    <h3 style="margin-top: 30px;">عناصر الفاتورة</h3>
                    <div class="invoice-items-table table-responsive" style="flex-grow: 1;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>المنتج</th>
                                    <th>الكمية</th>
                                    <th>السعر</th>
                                    <th>الإجمالي</th>
                                    <th>حذف</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceItemsBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="pos-right-panel" style="flex: 1; background: white; padding: 20px; border-radius: 8px;">
                    <h3>ملخص الفاتورة</h3>
                    <div class="invoice-summary">
                        <p style="display: flex; justify-content: space-between;">الإجمالي الفرعي: <span id="subTotal">0.00</span></p>
                        <div class="form-group">
                            <label for="discount">الخصم (مبلغ):</label>
                            <input type="number" id="discount" value="0" step="0.01" style="text-align: left; direction: ltr;">
                        </div>
                        <p style="display: flex; justify-content: space-between; font-size: 20px; font-weight: bold; border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px;">
                            المبلغ المستحق: <span id="grandTotal" style="color: var(--primary-color);">0.00</span>
                        </p>
                    </div>
                    <button class="btn btn-primary" id="completeSaleBtn" style="width: 100%; padding: 15px; font-size: 18px; margin-top: 20px;">
                        <i class="fas fa-check-circle"></i> إتمام البيع
                    </button>
                </div>
            </section>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Shared Setup
        const firebaseConfig = { apiKey: "AIzaSyAtePw7SP1R2POlPP9_Ot-YLNn0GQlebDg", authDomain: "pharmacy-6cc74.firebaseapp.com", projectId: "pharmacy-6cc74" };
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        auth.onAuthStateChanged(user => {
            if (user) { document.querySelector('.user-info span').textContent = `مرحباً، ${user.email.split('@')[0]}`; } 
            else { window.location.href = 'login.html'; }
        });
        document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());

        // POS Logic
        const searchInput = document.getElementById('posProductSearch');
        const searchResults = document.getElementById('posSearchResults');
        const invoiceItemsBody = document.getElementById('invoiceItemsBody');
        const subTotalEl = document.getElementById('subTotal');
        const discountEl = document.getElementById('discount');
        const grandTotalEl = document.getElementById('grandTotal');
        const completeSaleBtn = document.getElementById('completeSaleBtn');
        
        let invoiceItems = [];
        let searchTimeout;

        const renderInvoice = () => {
            invoiceItemsBody.innerHTML = '';
            invoiceItems.forEach((item, index) => {
                const row = invoiceItemsBody.insertRow();
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td><input type="number" value="${item.quantity}" min="1" data-index="${index}" style="width: 60px;"></td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${(item.price * item.quantity).toFixed(2)}</td>
                    <td><button class="btn btn-danger delete-item-btn" data-index="${index}"><i class="fas fa-trash"></i></button></td>
                `;
            });
            calculateTotals();
        };

        const calculateTotals = () => {
            const subTotal = invoiceItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const discount = parseFloat(discountEl.value) || 0;
            subTotalEl.textContent = subTotal.toFixed(2);
            grandTotalEl.textContent = (subTotal - discount).toFixed(2);
        };
        
        discountEl.addEventListener('input', calculateTotals);

        invoiceItemsBody.addEventListener('input', (e) => {
            if(e.target.tagName === 'INPUT'){
                const index = e.target.dataset.index;
                invoiceItems[index].quantity = parseInt(e.target.value);
                renderInvoice();
            }
        });
        
         invoiceItemsBody.addEventListener('click', (e) => {
            const btn = e.target.closest('.delete-item-btn');
            if(btn){
                const index = btn.dataset.index;
                invoiceItems.splice(index, 1);
                renderInvoice();
            }
        });

        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            const term = searchInput.value;
            if (term.length < 2) {
                searchResults.innerHTML = '<p class="no-data-row">أدخل حرفين على الأقل للبحث.</p>';
                return;
            };
            searchTimeout = setTimeout(async () => {
                const snapshot = await db.collection('products').where('name', '>=', term).where('name', '<=', term + '\uf8ff').limit(5).get();
                searchResults.innerHTML = '';
                snapshot.forEach(doc => {
                    const product = doc.data();
                    searchResults.innerHTML += `<div style="padding: 10px; border-bottom: 1px solid #eee; display:flex; justify-content: space-between; align-items: center; cursor: pointer;" class="add-item-btn" data-id="${doc.id}" data-name="${product.name}" data-price="${product.price}">
                        <span>${product.name} (المتاح: ${product.quantity}) - ${product.price.toFixed(2)} جنيه</span>
                        <button class="btn btn-primary"><i class="fas fa-plus"></i></button>
                    </div>`;
                });
            }, 300);
        });

        searchResults.addEventListener('click', (e) => {
            const itemDiv = e.target.closest('.add-item-btn');
            if(itemDiv){
                const newItem = { id: itemDiv.dataset.id, name: itemDiv.dataset.name, price: parseFloat(itemDiv.dataset.price), quantity: 1 };
                const existingItem = invoiceItems.find(item => item.id === newItem.id);
                if (existingItem) { existingItem.quantity++; } 
                else { invoiceItems.push(newItem); }
                renderInvoice();
            }
        });

        completeSaleBtn.addEventListener('click', async () => {
            if(invoiceItems.length === 0) return alert('الفاتورة فارغة!');
            const batch = db.batch();
            const saleData = {
                items: invoiceItems,
                grandTotal: parseFloat(grandTotalEl.textContent),
                discount: parseFloat(discountEl.value) || 0,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            let allQuantitiesAvailable = true;
            
            const productChecks = invoiceItems.map(item => db.collection('products').doc(item.id).get());
            const productDocs = await Promise.all(productChecks);

            for (let i = 0; i < productDocs.length; i++) {
                const doc = productDocs[i];
                const item = invoiceItems[i];
                if (!doc.exists || doc.data().quantity < item.quantity) {
                    alert(`الكمية غير كافية للمنتج: ${item.name}. المتاح: ${doc.data().quantity || 0}`);
                    allQuantitiesAvailable = false;
                    break;
                }
            }
            if(!allQuantitiesAvailable) return;
            
            invoiceItems.forEach(item => {
                const productRef = db.collection('products').doc(item.id);
                batch.update(productRef, { quantity: firebase.firestore.FieldValue.increment(-item.quantity) });
            });

            const saleRef = db.collection('sales').doc();
            batch.set(saleRef, saleData);

            try {
                await batch.commit();
                alert('تم البيع بنجاح!');
                invoiceItems = [];
                renderInvoice();
                discountEl.value = 0;
                searchInput.value = '';
                searchResults.innerHTML = '<p class="no-data-row">ابحث عن منتج لإضافته للفاتورة.</p>';
            } catch (error) {
                console.error("Sale failed: ", error);
                alert('فشل إتمام البيع.');
            }
        });
    });
    </script>
</body>
</html>